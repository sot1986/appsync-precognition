import{cleanString,getHeader,getNestedValue,isArray,setNestedValue}from"./utils.js";import{runtime,util}from"@aws-appsync/utils";function parse(e,v){let[y,...b]=typeof v==`string`?[v,void 0]:[v[0],...v.slice(1)];switch(y){case`required`:return requiredRule(e);case`nullable`:return nullableRule(e);case`sometimes`:return sometimesRule(e);case`min`:return minRule(e,b[0]);case`max`:return maxRule(e,b[0]);case`between`:return betweenRule(e,b[0],b[1]);case`regex`:return regexRule(e,...b);case`in`:return inRule(e,...b);case`notIn`:return notInRule(e,...b);case`array`:return arrayRule(e);case`object`:return objectRule(e);case`boolean`:return booleanRule(e);case`number`:return numberRule(e);case`string`:return stringRule(e);case`before`:return beforeRule(e,b[0]);case`after`:return afterRule(e,b[0]);case`beforeOrEqual`:return beforeOrEqualRule(e,b[0]);case`afterOrEqual`:return afterOrEqualRule(e,b[0]);default:return{check:!1,message:`Unknown rule ${y}`,value:e}}}function minRule(e,v){let y={check:!1,message:`:attribute must be greater than or equal to ${v}`,value:e};return typeof e==`number`&&(y.check=e>=v),typeof e==`string`&&(y.check=e.length>=v),isArray(e)&&(y.check=e.length>=v,y.message=`Array must contain at least ${v} elements`),y}function maxRule(e,v){let y={check:!1,message:`:attribute must be less than or equal to ${v}`,value:e};return typeof e==`number`&&(y.check=e<=v),typeof e==`string`&&(y.check=e.length<=v,y.message=`String must contain at most ${v} characters`),isArray(e)&&(y.check=e.length<=v,y.message=`Array must contain at most ${v} elements`),y}function betweenRule(e,v,y){let x={check:!1,message:`:attribute must be between ${v} and ${y}`,value:e};return typeof e==`number`&&(x.check=e>=v&&e<=y),typeof e==`string`&&(x.check=e.length>=v&&e.length<=y,x.message=`String must contain between ${v} and ${y} characters`),isArray(e)&&(x.check=e.length>=v&&e.length<=y,x.message=`Array must contain between ${v} and ${y} elements`),x}function regexRule(e,...v){let y={check:!1,message:`:attribute must match the specified regular expression`,value:e};return typeof e==`string`&&(y.check=v.some(v=>util.matches(v,e))),y}function inRule(e,...v){return{check:v.includes(e),message:`:attribute must be one of the specified values`,value:e}}function notInRule(e,...v){return{check:!v.includes(e),message:`:attribute must not be one of the specified values`,value:e}}function requiredRule(e){let v={check:!0,message:`:attribute is required`,value:e,skipNext:!0};return typeof e==`string`&&(v.check=e.length>0),isArray(e)&&(v.check=e.length>0),typeof e==`number`&&(v.check=!0),typeof e==`boolean`&&(v.check=!0),typeof e==`object`&&!v.value&&(v.message=`:attribute is not nullable`,v.check=!1),e===void 0&&(v.check=!1),v.skipNext=!v.check,v}function nullableRule(e){return{check:!0,message:``,value:e,skipNext:typeof e==`object`&&!e}}function sometimesRule(e){let v={check:!0,message:``,value:e};return e===void 0?(v.skipNext=!0,v):typeof e==`object`&&!v.value?(v.message=`:attribute is not nullable`,v.check=!1,v.skipNext=!0,v):requiredRule(e)}function arrayRule(e){let v={check:!1,message:`:attribute must be an array`,value:e};return isArray(e)&&(v.check=!0),v}function objectRule(e){let v={check:!1,message:`:attribute must be an object`,value:e};return typeof e==`object`&&!isArray(v.value)&&(v.check=!0),v}function booleanRule(e){let v={check:!1,message:`:attribute must be a boolean`,value:e};return typeof e==`boolean`&&(v.check=!0),v}function numberRule(e){let v={check:!1,message:`:attribute must be a number`,value:e};return typeof e==`number`&&(v.check=!0),v}function stringRule(e){let v={check:!1,message:`:attribute must be a string`,value:e};return typeof e==`string`&&(v.check=!0),v}function beforeRule(e,v){let y={check:!1,message:`:attribute must be before ${v}`,value:e};let b=util.time.parseISO8601ToEpochMilliSeconds(v);return typeof e==`string`&&(y.check=util.time.parseISO8601ToEpochMilliSeconds(e)<b),typeof e==`number`&&(y.check=e<b),y}function afterRule(e,v){let y={check:!1,message:`:attribute must be after ${v}`,value:e};let b=util.time.parseISO8601ToEpochMilliSeconds(v);return typeof e==`string`&&(y.check=util.time.parseISO8601ToEpochMilliSeconds(e)>b),typeof e==`number`&&(y.check=e>b),y}function beforeOrEqualRule(e,v){let y={check:!1,message:`:attribute must be before or equal to ${v}`,value:e};let b=util.time.parseISO8601ToEpochMilliSeconds(v);return typeof e==`string`&&(y.check=util.time.parseISO8601ToEpochMilliSeconds(e)<=b),typeof e==`number`&&(y.check=e<=b),y}function afterOrEqualRule(e,v){let y={check:!1,message:`:attribute must be after or equal to ${v}`,value:e};let b=util.time.parseISO8601ToEpochMilliSeconds(v);return typeof e==`string`&&(y.check=util.time.parseISO8601ToEpochMilliSeconds(e)>=b),typeof e==`number`&&(y.check=e>=b),y}function validate(v,S,w){let T={};if(Object.keys(S).forEach(E=>{let D=getNestedValue(v,E);typeof D==`string`&&(D=cleanString(D,w),setNestedValue(v,E,D));let O=!1;S[E]?.forEach(e=>{if(O)return;let v=typeof e==`string`||isArray(e)?parse(D,e):{...e};O=v.skipNext??!1,!v.check&&(T.msg&&util.appendError(T.msg,T.errorType,T.data,T.errorInfo),v.message=v.message.replace(`:attribute`,formatAttributeName(E)),T={msg:v.message,errorType:`ValidationError`,data:null,errorInfo:{path:E,value:D}},O=!0)})}),!T.msg)return v;util.error(T.msg,T.errorType,T.data,T.errorInfo)}function precognitiveValidation(e,y,b){if(getHeader(`precognition`,e)!==`true`)return validate(e.args,y,b);let x=getHeader(`Precognition-Validate-Only`,e)?.split(`,`).map(e=>e.trim());util.http.addResponseHeader(`Precognition`,`true`),x||(validate(e.args,y,b),util.http.addResponseHeader(`Precognition-Success`,`true`),runtime.earlyReturn(null)),util.http.addResponseHeader(`Precognition-Validate-Only`,x.join(`,`));let C={};x.forEach(e=>{C[e]=y[e]}),validate(e.args,C,b),util.http.addResponseHeader(`Precognition-Success`,`true`),runtime.earlyReturn(null,{skipTo:b?.skipTo??`END`})}function formatAttributeName(e){return e.split(`.`).reduce((e,v)=>util.matches(`^\\d+$`,v)?e:e?`${e} ${v.toLowerCase()}`:v.toLowerCase(),``)}export{formatAttributeName,precognitiveValidation,validate};