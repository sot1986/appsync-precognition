import{cleanString,getHeader,getNestedValue,isArray,setNestedValue}from"./utils.js";import{runtime,util}from"@aws-appsync/utils";function parse(e,d){const[f,...p]=typeof d===`string`?[d,void 0]:[d[0],...d.slice(1)];switch(f){case`required`:return requiredRule(e);case`nullable`:return nullableRule(e);case`sometimes`:return sometimesRule(e);case`min`:return betweenRule(e,p[0]);case`max`:return betweenRule(e,void 0,p[0]);case`between`:return betweenRule(e,p[0],p[1]);case`regex`:return regexRule(e,...p);case`in`:return inRule(e,...p);case`notIn`:return notInRule(e,...p);case`before`:return beforeRule(e,p[0]);case`after`:return afterRule(e,p[0]);case`beforeOrEqual`:return beforeOrEqualRule(e,p[0]);case`afterOrEqual`:return afterOrEqualRule(e,p[0]);default:return typeRule(e,f)}}function betweenRule(e,d=-Infinity,f=Infinity){const[m,h]=[d===-Infinity,f===Infinity];const g={check:false,message:m?`:attribute should be at most ${f}`:h?`:attribute should be at least ${d}`:`:attribute must be between ${d} and ${f}`,value:e};if(typeof e===`number`)g.check=e>=d&&e<=f;if(typeof e===`string`){g.check=e.length>=d&&e.length<=f;g.message=m?`String must not exceed ${f} characters`:h?`String must contain at least ${d} characters`:`String must contain between ${d} and ${f} characters`}if(isArray(e)){g.check=e.length>=d&&e.length<=f;g.message=m?`Array must not contain more than ${f} elements`:h?`Array must contain at least ${d} elements`:`Array must contain between ${d} and ${f} elements`}return g}function regexRule(e,...d){const f={check:false,message:`:attribute must match the specified regular expression`,value:e};if(typeof e===`string`)f.check=d.some(d=>util.matches(d,e));return f}function inRule(e,...d){return{check:d.includes(e),message:`:attribute must be one of the specified values`,value:e}}function notInRule(e,...d){return{check:!d.includes(e),message:`:attribute must not be one of the specified values`,value:e}}function requiredRule(e){const d={check:true,message:`:attribute is required`,value:e,skipNext:true};if(typeof e===`string`)d.check=e.length>0;if(isArray(e))d.check=e.length>0;if(typeof e===`number`)d.check=true;if(typeof e===`boolean`)d.check=true;if(typeof e===`object`&&!d.value){d.message=`:attribute is not nullable`;d.check=false}if(typeof e===`undefined`)d.check=false;d.skipNext=!d.check;return d}function nullableRule(e){return{check:true,message:`:attribute must be nullable`,value:e,skipNext:typeof e===`undefined`||e===null}}function sometimesRule(e){const d={check:true,message:`:attribute is not nullable`,value:e};if(typeof e===`undefined`){d.skipNext=true;return d}if(typeof e===`object`&&!d.value){d.check=false;d.skipNext=true;return d}return requiredRule(e)}function typeRule(e,d){const f={check:false,message:`:attribute must be a ${d}`,value:e};switch(d){case`array`:f.check=isArray(e);break;case`object`:f.check=typeof e===`object`&&!!e&&!isArray(e)&&Object.keys(e).length>0;break;case`boolean`:f.check=typeof e===`boolean`;break;case`number`:f.check=typeof e===`number`;break;default:f.check=typeof e===`string`}return f}function beforeRule(e,d){const f={check:false,message:`:attribute must be before ${d}`,value:e};const p=util.time.parseISO8601ToEpochMilliSeconds(d);if(typeof e===`string`)f.check=util.time.parseISO8601ToEpochMilliSeconds(e)<p;if(typeof e===`number`)f.check=e<p;return f}function afterRule(e,d){const f={check:false,message:`:attribute must be after ${d}`,value:e};const p=util.time.parseISO8601ToEpochMilliSeconds(d);if(typeof e===`string`)f.check=util.time.parseISO8601ToEpochMilliSeconds(e)>p;if(typeof e===`number`)f.check=e>p;return f}function beforeOrEqualRule(e,d){const f={check:false,message:`:attribute must be before or equal to ${d}`,value:e};const p=util.time.parseISO8601ToEpochMilliSeconds(d);if(typeof e===`string`)f.check=util.time.parseISO8601ToEpochMilliSeconds(e)<=p;if(typeof e===`number`)f.check=e<=p;return f}function afterOrEqualRule(e,d){const f={check:false,message:`:attribute must be after or equal to ${d}`,value:e};const p=util.time.parseISO8601ToEpochMilliSeconds(d);if(typeof e===`string`)f.check=util.time.parseISO8601ToEpochMilliSeconds(e)>=p;if(typeof e===`number`)f.check=e>=p;return f}function validate(d,h,v){let y={};Object.keys(h).forEach(b=>{let x=getNestedValue(d,b);if(typeof x===`string`){x=cleanString(x,v);setNestedValue(d,b,x)}let S=false;h[b]?.forEach(e=>{if(S)return;const d=typeof e===`string`||isArray(e)?parse(x,e):{...e};S=!!d.skipNext||!d.check;if(d.check)return;if(y.msg)util.appendError(y.msg,y.errorType,y.data,y.errorInfo);d.message=d.message.replace(`:attribute`,formatAttributeName(b));y={msg:d.message,errorType:`ValidationError`,data:null,errorInfo:{path:b,value:x}}})});if(!y.msg)return d;util.error(y.msg,y.errorType,y.data,y.errorInfo)}function precognitiveValidation(e,f,p){if(getHeader(`precognition`,e)!==`true`)return validate(e.args,f,p);const m=getHeader(`Precognition-Validate-Only`,e)?.split(`,`).map(e=>e.trim());util.http.addResponseHeader(`Precognition`,`true`);if(!m){validate(e.args,f,p);util.http.addResponseHeader(`Precognition-Success`,`true`);runtime.earlyReturn(null)}util.http.addResponseHeader(`Precognition-Validate-Only`,m.join(`,`));const _={};m.forEach(e=>{_[e]=f[e]});validate(e.args,_,p);util.http.addResponseHeader(`Precognition-Success`,`true`);runtime.earlyReturn(null,{skipTo:p?.skipTo??`END`})}function formatAttributeName(e){return e.split(`.`).reduce((e,d)=>{if(util.matches(`^\\d+$`,d))return e;let f=``;d.split(``).forEach((e,d)=>{if(d!==0&&util.matches(`[A-Z]`,e))f+=` `;f+=e.toLowerCase()});return e?`${e} ${f}`:f},``)}export{formatAttributeName,precognitiveValidation,validate};