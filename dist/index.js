import{cleanString as e,getHeader as t,getNestedValue as n,isArray as r,setNestedValue as i}from"./utils.js";import{runtime as a,util as o}from"@aws-appsync/utils";function s(e,t){let[n,...r]=typeof t==`string`?[t,void 0]:[t[0],...t.slice(1)];switch(n){case`required`:return m(e);case`nullable`:return h(e);case`sometimes`:return g(e);case`min`:return c(e,r[0]);case`max`:return l(e,r[0]);case`between`:return u(e,r[0],r[1]);case`regex`:return d(e,...r);case`in`:return f(e,...r);case`notIn`:return p(e,...r);case`array`:return _(e);case`object`:return v(e);case`boolean`:return y(e);case`number`:return b(e);case`string`:return x(e);case`before`:return S(e,r[0]);case`after`:return C(e,r[0]);case`beforeOrEqual`:return w(e,r[0]);case`afterOrEqual`:return T(e,r[0]);default:return{check:!1,message:`Unknown rule ${n}`,value:e}}}function c(e,t){let n={check:!1,message:`:attribute must be greater than or equal to ${t}`,value:e};return typeof e==`number`&&(n.check=e>=t),typeof e==`string`&&(n.check=e.length>=t),r(e)&&(n.check=e.length>=t,n.message=`Array must contain at least ${t} elements`),n}function l(e,t){let n={check:!1,message:`:attribute must be less than or equal to ${t}`,value:e};return typeof e==`number`&&(n.check=e<=t),typeof e==`string`&&(n.check=e.length<=t,n.message=`String must contain at most ${t} characters`),r(e)&&(n.check=e.length<=t,n.message=`Array must contain at most ${t} elements`),n}function u(e,t,n){let i={check:!1,message:`:attribute must be between ${t} and ${n}`,value:e};return typeof e==`number`&&(i.check=e>=t&&e<=n),typeof e==`string`&&(i.check=e.length>=t&&e.length<=n,i.message=`String must contain between ${t} and ${n} characters`),r(e)&&(i.check=e.length>=t&&e.length<=n,i.message=`Array must contain between ${t} and ${n} elements`),i}function d(e,...t){let n={check:!1,message:`:attribute must match the specified regular expression`,value:e};return typeof e==`string`&&(n.check=t.some(t=>o.matches(t,e))),n}function f(e,...t){return{check:t.includes(e),message:`:attribute must be one of the specified values`,value:e}}function p(e,...t){return{check:!t.includes(e),message:`:attribute must not be one of the specified values`,value:e}}function m(e){let t={check:!0,message:`:attribute is required`,value:e,skipNext:!0};return typeof e==`string`&&(t.check=e.length>0),r(e)&&(t.check=e.length>0),typeof e==`number`&&(t.check=!0),typeof e==`boolean`&&(t.check=!0),typeof e==`object`&&!t.value&&(t.message=`:attribute is not nullable`,t.check=!1),e===void 0&&(t.check=!1),t.skipNext=!t.check,t}function h(e){return{check:!0,message:``,value:e,skipNext:typeof e==`object`&&!e}}function g(e){let t={check:!0,message:``,value:e};return e===void 0?(t.skipNext=!0,t):typeof e==`object`&&!t.value?(t.message=`:attribute is not nullable`,t.check=!1,t.skipNext=!0,t):m(e)}function _(e){let t={check:!1,message:`:attribute must be an array`,value:e};return r(e)&&(t.check=!0),t}function v(e){let t={check:!1,message:`:attribute must be an object`,value:e};return typeof e==`object`&&!r(t.value)&&(t.check=!0),t}function y(e){let t={check:!1,message:`:attribute must be a boolean`,value:e};return typeof e==`boolean`&&(t.check=!0),t}function b(e){let t={check:!1,message:`:attribute must be a number`,value:e};return typeof e==`number`&&(t.check=!0),t}function x(e){let t={check:!1,message:`:attribute must be a string`,value:e};return typeof e==`string`&&(t.check=!0),t}function S(e,t){let n={check:!1,message:`:attribute must be before ${t}`,value:e},r=o.time.parseISO8601ToEpochMilliSeconds(t);return typeof e==`string`&&(n.check=o.time.parseISO8601ToEpochMilliSeconds(e)<r),typeof e==`number`&&(n.check=e<r),n}function C(e,t){let n={check:!1,message:`:attribute must be after ${t}`,value:e},r=o.time.parseISO8601ToEpochMilliSeconds(t);return typeof e==`string`&&(n.check=o.time.parseISO8601ToEpochMilliSeconds(e)>r),typeof e==`number`&&(n.check=e>r),n}function w(e,t){let n={check:!1,message:`:attribute must be before or equal to ${t}`,value:e},r=o.time.parseISO8601ToEpochMilliSeconds(t);return typeof e==`string`&&(n.check=o.time.parseISO8601ToEpochMilliSeconds(e)<=r),typeof e==`number`&&(n.check=e<=r),n}function T(e,t){let n={check:!1,message:`:attribute must be after or equal to ${t}`,value:e},r=o.time.parseISO8601ToEpochMilliSeconds(t);return typeof e==`string`&&(n.check=o.time.parseISO8601ToEpochMilliSeconds(e)>=r),typeof e==`number`&&(n.check=e>=r),n}function E(t,a,c){let l={};if(Object.keys(a).forEach(u=>{let d=n(t,u);typeof d==`string`&&(d=e(d,c),i(t,u,d));let f=!1;a[u]?.forEach(e=>{if(f)return;let t=typeof e==`string`||r(e)?s(d,e):{...e};f=t.skipNext??!1,!t.check&&(l.msg&&o.appendError(l.msg,l.errorType,l.data,l.errorInfo),t.message=t.message.replace(`:attribute`,O(u)),l={msg:t.message,errorType:`ValidationError`,data:null,errorInfo:{path:u,value:d}},f=!0)})}),!l.msg)return t;o.error(l.msg,l.errorType,l.data,l.errorInfo)}function D(e,n,r){if(t(`precognition`,e)!==`true`)return E(e.args,n,r);let i=t(`Precognition-Validate-Only`,e)?.split(`,`).map(e=>e.trim());o.http.addResponseHeader(`Precognition`,`true`),i||(E(e.args,n,r),o.http.addResponseHeader(`Precognition-Success`,`true`),a.earlyReturn(null)),o.http.addResponseHeader(`Precognition-Validate-Only`,i.join(`,`));let s={};i.forEach(e=>{s[e]=n[e]}),E(e.args,s,r),o.http.addResponseHeader(`Precognition-Success`,`true`),a.earlyReturn(null,{skipTo:r?.skipTo??`END`})}function O(e){return e.split(`.`).reduce((e,t)=>o.matches(`^\\d+$`,t)?e:e?`${e} ${t.toLowerCase()}`:t.toLowerCase(),``)}export{O as formatAttributeName,D as precognitiveValidation,E as validate};