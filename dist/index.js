import{cleanString,getHeader,getNestedValue,isArray,setNestedValue}from"./utils.js";import{runtime,util}from"@aws-appsync/utils";function parse(e,v){const[y,...b]=typeof v===`string`?[v,void 0]:[v[0],...v.slice(1)];switch(y){case`required`:return requiredRule(e);case`nullable`:return nullableRule(e);case`sometimes`:return sometimesRule(e);case`min`:return minRule(e,b[0]);case`max`:return maxRule(e,b[0]);case`between`:return betweenRule(e,b[0],b[1]);case`regex`:return regexRule(e,...b);case`in`:return inRule(e,...b);case`notIn`:return notInRule(e,...b);case`array`:return arrayRule(e);case`object`:return objectRule(e);case`boolean`:return booleanRule(e);case`number`:return numberRule(e);case`string`:return stringRule(e);case`before`:return beforeRule(e,b[0]);case`after`:return afterRule(e,b[0]);case`beforeOrEqual`:return beforeOrEqualRule(e,b[0]);case`afterOrEqual`:return afterOrEqualRule(e,b[0]);default:return{check:false,message:`Unknown rule ${y}`,value:e}}}function minRule(e,v){const y={check:false,message:`:attribute must be greater than or equal to ${v}`,value:e};if(typeof e===`number`)y.check=e>=v;if(typeof e===`string`)y.check=e.length>=v;if(isArray(e)){y.check=e.length>=v;y.message=`Array must contain at least ${v} elements`}return y}function maxRule(e,v){const y={check:false,message:`:attribute must be less than or equal to ${v}`,value:e};if(typeof e===`number`)y.check=e<=v;if(typeof e===`string`){y.check=e.length<=v;y.message=`String must contain at most ${v} characters`}if(isArray(e)){y.check=e.length<=v;y.message=`Array must contain at most ${v} elements`}return y}function betweenRule(e,v,y){const x={check:false,message:`:attribute must be between ${v} and ${y}`,value:e};if(typeof e===`number`)x.check=e>=v&&e<=y;if(typeof e===`string`){x.check=e.length>=v&&e.length<=y;x.message=`String must contain between ${v} and ${y} characters`}if(isArray(e)){x.check=e.length>=v&&e.length<=y;x.message=`Array must contain between ${v} and ${y} elements`}return x}function regexRule(e,...v){const y={check:false,message:`:attribute must match the specified regular expression`,value:e};if(typeof e===`string`)y.check=v.some(v=>util.matches(v,e));return y}function inRule(e,...v){return{check:v.includes(e),message:`:attribute must be one of the specified values`,value:e}}function notInRule(e,...v){return{check:!v.includes(e),message:`:attribute must not be one of the specified values`,value:e}}function requiredRule(e){const v={check:true,message:`:attribute is required`,value:e,skipNext:true};if(typeof e===`string`)v.check=e.length>0;if(isArray(e))v.check=e.length>0;if(typeof e===`number`)v.check=true;if(typeof e===`boolean`)v.check=true;if(typeof e===`object`&&!v.value){v.message=`:attribute is not nullable`;v.check=false}if(typeof e===`undefined`)v.check=false;v.skipNext=!v.check;return v}function nullableRule(e){return{check:true,message:``,value:e,skipNext:typeof e===`object`&&!e}}function sometimesRule(e){const v={check:true,message:``,value:e};if(typeof e===`undefined`){v.skipNext=true;return v}if(typeof e===`object`&&!v.value){v.message=`:attribute is not nullable`;v.check=false;v.skipNext=true;return v}return requiredRule(e)}function arrayRule(e){const v={check:false,message:`:attribute must be an array`,value:e};if(isArray(e))v.check=true;return v}function objectRule(e){const v={check:false,message:`:attribute must be an object`,value:e};if(typeof e===`object`&&!isArray(v.value))v.check=true;return v}function booleanRule(e){const v={check:false,message:`:attribute must be a boolean`,value:e};if(typeof e===`boolean`)v.check=true;return v}function numberRule(e){const v={check:false,message:`:attribute must be a number`,value:e};if(typeof e===`number`)v.check=true;return v}function stringRule(e){const v={check:false,message:`:attribute must be a string`,value:e};if(typeof e===`string`)v.check=true;return v}function beforeRule(e,v){const y={check:false,message:`:attribute must be before ${v}`,value:e};const b=util.time.parseISO8601ToEpochMilliSeconds(v);if(typeof e===`string`)y.check=util.time.parseISO8601ToEpochMilliSeconds(e)<b;if(typeof e===`number`)y.check=e<b;return y}function afterRule(e,v){const y={check:false,message:`:attribute must be after ${v}`,value:e};const b=util.time.parseISO8601ToEpochMilliSeconds(v);if(typeof e===`string`)y.check=util.time.parseISO8601ToEpochMilliSeconds(e)>b;if(typeof e===`number`)y.check=e>b;return y}function beforeOrEqualRule(e,v){const y={check:false,message:`:attribute must be before or equal to ${v}`,value:e};const b=util.time.parseISO8601ToEpochMilliSeconds(v);if(typeof e===`string`)y.check=util.time.parseISO8601ToEpochMilliSeconds(e)<=b;if(typeof e===`number`)y.check=e<=b;return y}function afterOrEqualRule(e,v){const y={check:false,message:`:attribute must be after or equal to ${v}`,value:e};const b=util.time.parseISO8601ToEpochMilliSeconds(v);if(typeof e===`string`)y.check=util.time.parseISO8601ToEpochMilliSeconds(e)>=b;if(typeof e===`number`)y.check=e>=b;return y}function validate(v,S,w){let T={};Object.keys(S).forEach(E=>{let D=getNestedValue(v,E);if(typeof D===`string`){D=cleanString(D,w);setNestedValue(v,E,D)}let O=false;S[E]?.forEach(e=>{if(O)return;const v=typeof e===`string`||isArray(e)?parse(D,e):{...e};O=v.skipNext??false;if(v.check)return;if(T.msg)util.appendError(T.msg,T.errorType,T.data,T.errorInfo);v.message=v.message.replace(`:attribute`,formatAttributeName(E));T={msg:v.message,errorType:`ValidationError`,data:null,errorInfo:{path:E,value:D}};O=true})});if(!T.msg)return v;util.error(T.msg,T.errorType,T.data,T.errorInfo)}function precognitiveValidation(e,y,b){if(getHeader(`precognition`,e)!==`true`)return validate(e.args,y,b);const x=getHeader(`Precognition-Validate-Only`,e)?.split(`,`).map(e=>e.trim());util.http.addResponseHeader(`Precognition`,`true`);if(!x){validate(e.args,y,b);util.http.addResponseHeader(`Precognition-Success`,`true`);runtime.earlyReturn(null)}util.http.addResponseHeader(`Precognition-Validate-Only`,x.join(`,`));const C={};x.forEach(e=>{C[e]=y[e]});validate(e.args,C,b);util.http.addResponseHeader(`Precognition-Success`,`true`);runtime.earlyReturn(null,{skipTo:b?.skipTo??`END`})}function formatAttributeName(e){return e.split(`.`).reduce((e,v)=>{if(util.matches(`^\\d+$`,v))return e;return e?`${e} ${v.toLowerCase()}`:v.toLowerCase()},``)}export{formatAttributeName,precognitiveValidation,validate};